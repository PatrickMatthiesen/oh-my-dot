name: Winget Release

on:
  release:
    types: [published]

jobs:
  winget-release:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check if version is major or minor
        id: version_check
        run: |
          $version = "${{ github.event.release.tag_name }}" -replace '^v', ''
          $parts = $version -split '\.'
          
          if ($parts.Count -ge 3) {
            $patch = [int]$parts[2]
            if ($patch -eq 0) {
              echo "is_major_minor=true" >> $env:GITHUB_OUTPUT
              echo "Version $version is a major or minor release (patch is 0)"
            } else {
              echo "is_major_minor=false" >> $env:GITHUB_OUTPUT
              echo "Version $version is a patch release (patch is $patch) - skipping Winget submission"
            }
          } else {
            echo "is_major_minor=true" >> $env:GITHUB_OUTPUT
            echo "Invalid version format, defaulting to true"
          }

      - name: Submit package to Winget
        if: steps.version_check.outputs.is_major_minor == 'true'
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: PatrickMatthiesen.oh-my-dot
          installers-regex: '\.exe$'
          token: ${{ secrets.WINGET_TOKEN }}
